name: InferenceSystem

on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main
  workflow_dispatch: # Allow manual workflow invocation from the Github Actions UI

concurrency:
  # Cancel any CI/CD workflow currently in progress for the same PR.
  # Allow running concurrently with any other commits.
  group: build-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions:  # added using https://github.com/step-security/secure-repo
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
    steps:
    - name: Checkout
      uses: actions/checkout@v5
    - name: Check for file changes
      uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
      id: filter
      with:
        filters: |
          src:
            - InferenceSystem/**
            - .github/workflows/InferenceSystem.yaml

  test-windows:
    runs-on: windows-latest
    needs: changes
    if: ${{ needs.changes.outputs.src == 'true' }}
    steps:
    - name: Check out
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Download model
      id: model-path
      run: |
        mkdir -p InferenceSystem/model
        curl -o InferenceSystem/model.zip https://trainedproductionmodels.blob.core.windows.net/dnnmodel/11-15-20.FastAI.R1-12.zip
        unzip InferenceSystem/model.zip -d InferenceSystem
        echo "path=InferenceSystem/model" >> $GITHUB_OUTPUT

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-v2-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-v2-

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install FFmpeg
      run: choco install ffmpeg -y

    - name: Create environment
      working-directory: InferenceSystem
      run: |
        python -m venv inference-venv

    - name: Set up environment
      working-directory: InferenceSystem
      shell: cmd
      run: |
        call .\inference-venv\Scripts\activate.bat && python -m pip install --upgrade pip && pip install -r requirements.txt

    - name: Patch fastai_audio for Python 3.11+ compatibility
      working-directory: InferenceSystem
      shell: cmd
      run: |
        call .\inference-venv\Scripts\activate.bat && patch_fastai_audio.bat

    - name: Test with FastAI LiveHLS config
      working-directory: InferenceSystem
      shell: cmd
      run: |
        call .\inference-venv\Scripts\activate.bat && python src/LiveInferenceOrchestrator.py --config ./config/Test/FastAI_LiveHLS_OrcasoundLab.yml --max_iterations 1

    - name: Test with FastAI DateRangeHLS config
      working-directory: InferenceSystem
      shell: cmd
      run: |
        call .\inference-venv\Scripts\activate.bat && python src/LiveInferenceOrchestrator.py --config ./config/Test/FastAI_DateRangeHLS_OrcasoundLab.yml --max_iterations 1

  test-ubuntu:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.src == 'true' }}
    steps:
    - name: Check out
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Download model
      id: model-path
      run: |
        mkdir -p InferenceSystem/model
        curl -o InferenceSystem/model.zip https://trainedproductionmodels.blob.core.windows.net/dnnmodel/11-15-20.FastAI.R1-12.zip
        unzip InferenceSystem/model.zip -d InferenceSystem
        echo "path=InferenceSystem/model" >> $GITHUB_OUTPUT

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-v2-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-v2-

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        # Remove unnecessary packages to free up space for pip install
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/lib/android
        sudo apt-get clean
        sudo apt-get autoremove -y
        echo "Disk space after cleanup:"
        df -h

    - name: Create environment
      working-directory: InferenceSystem
      run: |
        python -m venv inference-venv

    - name: Set up environment
      working-directory: InferenceSystem
      run: |
        source ./inference-venv/bin/activate && python -m pip install --upgrade pip && pip install -r requirements.txt

    - name: Patch fastai_audio for Python 3.11+ compatibility
      working-directory: InferenceSystem
      run: |
        source ./inference-venv/bin/activate && bash patch_fastai_audio.sh

    - name: Test with FastAI LiveHLS config
      working-directory: InferenceSystem
      run: |
        source ./inference-venv/bin/activate && python src/LiveInferenceOrchestrator.py --config ./config/Test/FastAI_LiveHLS_OrcasoundLab.yml --max_iterations 1

    - name: Test with FastAI DateRangeHLS config
      working-directory: InferenceSystem
      run: |
        source ./inference-venv/bin/activate && python src/LiveInferenceOrchestrator.py --config ./config/Test/FastAI_DateRangeHLS_OrcasoundLab.yml --max_iterations 1

  test-docker:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.src == 'true' }}

    permissions:
      contents: read

    steps:
    - uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
      with:
        egress-policy: audit

    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: Free up disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        # Remove unnecessary packages and cached files
        sudo apt-get clean
        sudo apt-get autoremove -y
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/.ghcup
        sudo rm -rf /usr/share/swift
        # Clean up Docker
        docker system prune -af
        echo "Disk space after cleanup:"
        df -h

    - name: Download model
      working-directory: InferenceSystem
      run: |
        curl -o model.zip https://trainedproductionmodels.blob.core.windows.net/dnnmodel/11-15-20.FastAI.R1-12.zip

    - name: Create environment variable file
      working-directory: InferenceSystem
      run: |
        touch .env

    - name: Build docker container
      working-directory: InferenceSystem
      run: |
        docker build . -t live-inference-system -f ./Dockerfile

    - name: Test docker container
      working-directory: InferenceSystem
      run: |
        docker run --rm \
          --env-file .env \
          live-inference-system \
          python3 -u ./src/LiveInferenceOrchestrator.py \
          --config ./config/Test/FastAI_LiveHLS_OrcasoundLab.yml \
          --max_iterations 1

    - name: Save docker container to tar file
      working-directory: InferenceSystem
      run: |
        docker save live-inference-system | gzip > live-inference-system.tar.gz

    - name: Upload docker container as artifact
      uses: actions/upload-artifact@v5
      with:
        name: live-inference-system-docker-image
        path: InferenceSystem/live-inference-system.tar.gz
        retention-days: 5
